---
title: "`rnhanesdata` Exploration"
output: 
  html_document:
    theme: flatly
    highlight: pygments
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

# global default settings for chunks
knitr::opts_chunk$set(echo = TRUE, eval = TRUE,
                      fig.dim = c(10, 4), 
                      fig.align = "center"
                      )

# loaded packages; placed here to be able to load global settings
Packages <- c("tidyverse", "dplyr")
invisible(lapply(Packages, library, character.only = TRUE))



# global settings for color palettes
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# theme global setting for ggplot
theme_set(theme_minimal() + 
            theme(legend.position = "bottom") +
            theme(plot.title = element_text(hjust = 0.5, size = 12),
                  plot.subtitle = element_text(hjust = 0.5, size = 8))
          )

```

This section details my exploration of the `rnhanesdata` package that was the initial objective of my project (which evolved into something else eventually). This was the earliest attempt to explore what the dataset contains and whether or not I could develop something out of the provided dataset. 

# Loading Dataset

We first install/load the `rnhanesdata` package.

```{r package load}
# devtools::install_github("andrew-leroux/rnhanesdata")
library(rnhanesdata)
```

## Datasets

The package contains 2 waves of NHANES dataset; 2003-2004 and 2005-2006 (labeled wave C and D, respectively). There are two main categories, "processed" and "raw" datasets. Details below:

* Processed:
  * `PAXINTEN_C` & `PAXINTEN_D`: Accelerometry data
  * `Flags_C` & `Flags_D`: Wear/non-wear flags
  * `Covariate_C` & `Covariate_D`: Additional NHANES dataset containing select, processed covariates. 
  * `Mortality_2011_C` & `Mortality_2011_D`: Processed mortality data.
* Raw:
  * `ALQ_C` & `ALQ_D`: Alcohol consumption dataset
  * `BMX_C` & `BMX_D`: Body measurement datasets
  * `BPX_C` & `BPX_D`: Blood pressure data
  * `DEMO_C` & `DEMO_D`: Demographic data
  * `DIQ_C` & `DIQ_D`: Diabetes questionnaire data
  * `MCQ_C` & `MCQ_D`: Medical conditions questionnaire
  * `PFQ_C` & `PFQ_D`: Physical function questionnaire data
  * `SMQ_C` & `SMQ_D`: Smoking status questionnaire
  * `NHANES_2003-2004_MORT_2011_PUBLIC`: Raw mortality data 2003-2004
  * `NHANES_2005-2006_MORT_2011_PUBLIC`: Raw mortality data 2005-2006

## Functions

In addition to these datasets, the package also contains several functions that are useful to further clean the dataset, re-calculate survey weights, etc. Firstly, the function `process_covar()` allows us to obtain raw data on chosen variables or, if we apply the option `extractAll = TRUE`, to obtain raw data from all possible variables in NHANES waves C & D. 

The function `reweight_accel()` re-calculates 2-year and 4-year survey weights for a dataset after processing/cleaning has been done. 

The function `exclude_accel()` takes in the activity and flag datasets to return indices of days which were considered "good datapoints" from a combination of wear/non-wear flag and NHANES's criteria for data quality.

They also had other functions, `process_accel()` and `process_flags()` with the purpose of downloading accelerometry and flag data from NHANES and formatting the data into a 1440+ format (minute-by-minute).

# Processed Data Exploration

Having seen the contents and functions of `rnhanesdata` package, we will explore them further.

## Accelerometer Data

```{r accel data load}
data("PAXINTEN_C")
data("PAXINTEN_D")

# Wave C data clean to remove the min-variables
accelC_id <- PAXINTEN_C %>% 
  janitor::clean_names() %>% 
  mutate(across(c("seqn", "paxcal", "paxstat", "weekday", "sddsrvyr"), factor)) %>% 
  select(-starts_with("min"))

# Wave D data clean to remove the min-variables
accelD_id <- PAXINTEN_D %>% 
  janitor::clean_names() %>% 
  mutate(across(c("seqn", "paxcal", "paxstat", "weekday", "sddsrvyr"), factor)) %>% 
  select(-starts_with("min"))
```
  
Both of these datasets contain similar variables:

* `SEQN`: Unique subject ID
* `PAXCAL`: Device calibration with 1 = yes, 2 = no, 9 = unknown
* `PAXSTAT`: Data reliability status with 1 = reliable, 2 = questionable
* `SDDSRVYR`: Indicates which wave the data comes from. 3 = 2003-2004, 4 = 2005-2006
* `WEEKDAY`: Day of the week with 1 as Sunday, 7 as Saturday
* `MIN1`- `MIN1440`: Activity count at each minute of the day (1440+ format)

The `SEQN` variable ranges between `r min(PAXINTEN_C$SEQN)` - `r max(PAXINTEN_C$SEQN)` for wave C and ranges between `r min(PAXINTEN_D$SEQN)` - `r max(PAXINTEN_D$SEQN)` for wave D. As noted from the range between these two waves, it appears that NHANES assumes none of the individuals are repeat-measures i.e. they're all assumed different individuals. 

A quick summary below using the `skimr::skim_without_charts()` function for wave C

```{r skim accel}
accelC_id %>% skimr::skim_without_charts()
```

```{r remove accel data, include = FALSE}
rm(list=c("accelC_id", "accelD_id", "PAXINTEN_C", "PAXINTEN_D"))
```

## Flags Data

```{r flags_data}
# load flag data
data("Flags_C")
data("Flags_D")

# Wave C data clean to remove the min-variables
flagC_id <- Flags_C %>% 
  janitor::clean_names() %>% 
  mutate(across(c("seqn", "paxcal", "paxstat", "weekday", "sddsrvyr"), factor)) %>% 
  select(-starts_with("min"))

# Wave D data clean to remove the min-variables
flagD_id <- Flags_D %>% 
  janitor::clean_names() %>% 
  mutate(across(c("seqn", "paxcal", "paxstat", "weekday", "sddsrvyr"), factor)) %>% 
  select(-starts_with("min"))
```

The flags data appear to contain similar primary variables as in `PAXINTEN_C` & `PAXINTEN_D`. Slightly different to the activity dataset however, is the measures within the 1440+ format. While the activity dataset has numeric variables, the flags are binary with only `0` (non-wear) or `1` (wear), though there are some `NA` values. 

```{r remove flag data}
rm(list=c("flagC_id", "flagD_id", "Flags_C", "Flags_D"))
```


## [Covariate Data](#processed-data-exploration)

Based on the vignette? it appears that the raw NHANES data beyond accelerometry are collated within the "covariates data". This will be explored further below.

```{r covar_data}

covarC <- Covariate_C %>% 
  janitor::clean_names() %>% 
  nest(wave_C_covar = sddsrvyr:smoke_cigs)
  

covarD <- Covariate_D %>% 
  janitor::clean_names() %>% 
  nest(wave_D_covar = sddsrvyr:smoke_cigs)


joined_covar <- full_join(covarC, covarD, by = 'seqn')

```

Unlike flag and accelerometer data, these covar data are not structured similarly to the other two and therefore might benefit from being a separate dataset. Unique identifier still exist and thus can be joined if necessary. This will be easily possible if we can maintain nested dataset of both flag and accelerometer. 

Additionally, the amount of `seqn` observations in the covariates are more than `seqn` within flag and accelerometer. With both wave C and D combined, we have `r nrow(joined_covar)` observations. We should left join this if we plan to merge the datasets. 

Furthermore, the covariates inside were not the complete covariates from the NHANES raw data. In these "cleaned" dataset, covariates are:

* `SDDSRVYR`: Wave indicator as in other datasets
* `SDMVPSU`: Masked variance pseudo probability sampling units. Used for variance estimation??
* `SDMVSTRA`: Masked variance pseudo stratum. Used for variance estimation??
* `WTINT2YR`: Full sample interviewed weight (likely reported weight)
* `WTMEC2YR`: Full sample examination weight (likely observed weight)
* `RIDAGEMN`: Age in months at screening date for those < 85 years. >= 85 is coded as NA
* `RIDAGEEX`: Age in months at examination date for those < 85 years. >= 85 is coded as NA
* `RIDAGEYR`: Age in years at date of screening
* `BMI`: BMI in kg/m^2. A copy of BMXBMI variable.
* `BMI_cat`: Category for the BMI values. underweight (<= 18.5), normal (18.5 < x <= 25), overweight (25 < x <= 30), obese (> 30)
* Self-reported survey answers:
  * `Race`: ethnicity
  * `Gender`: gender for M/F
  * `Diabetes`: diagnosed diabetes, categorized to Yes, No, Borderline, Refused, Don't know. 
  * `CHF`: diagnosed CHF, categorized as yes, no, refused, don't know (variable MCQ160B in raw)
  * `CHD`: diagnosed CHD, categorized as yes, no refused, don't know (variable MCQ160C)
  * `Cancer`: diagnosed history of any cancer. Categorized as yes, no, refused, don't know (MCQ220)
  * `Stroke`: diagnosed history of stroke, categorized as yes, no, refused, or don't know. (MCQ160F)
  * `Education_adult`: Present only in wave D
  * `Mobility_Problem`: mobility issue categorized into any vs. no difficulty. Derived from responses of (PFQ-049, -054, -057, -059, -061B, -61C). Details in vignette.
  * `Drink_Status`: current alcohol consumption categorized as non-, moderate-, or heavy-drinker. Details in vignette
  * `Drinks_Per_Week`: number of drinks per week. Details in vignette
  * `Smoke_Cigs`: cigarette smoking status categorized as never, former, or current. Details in vignette. 

## [Mortality Data](#processed-data-exploration)

Processed mortality data for NHANES, released in 2011 for waves C and D. 

They have mortality data from 2011 and 2015. We will explore the more recent 2015 data for now. 

```{r}

mort_2015_c <- Mortality_2015_C %>% 
  janitor::clean_names()


mort_2015_d <- Mortality_2015_D %>% 
  janitor::clean_names()


```

Obtaining the processed mortality table shows a number of unique observations of `r nrow(mort_2015_d)`, similar to the number found in covariates data. As such, we should likely `left_join` this table to accel or flag dataset to have consistent data throughout. Checking on the mortality table, we see several new variables besides `seqn`:

* `eligstat`: eligibility for mortality follow-up. 1 = eligible, 2 = <18 yrs (not available for public), 3 = ineligible
* `mortstat`: indicator for mortality status at f/u time from permth_exm and permth_int. 0 = assumed alive, 1 = assumed deceased, NA = <18 yrs (not available)
* `permth_exm`: time in months when mortality assessment was done (date of mortality assessment)
* `permth_int`: time in months from interview to mortality assessment
* `ucod_leading`: underlying cause of death (recoded from UCOD_113). Details in vignette
* `diabetes_mcod`: diabetes flag from multiple cause of death (dm part of cause?)
* `hyperten_mcod`: hypertension flag from multiple cause of death (htn part of cause?)