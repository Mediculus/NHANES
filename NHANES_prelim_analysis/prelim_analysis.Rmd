---
title: "NHANES Consolidated Data EDA"
author: "Kevin S.W. --- UNI: ksw2137"
date: "`r format(Sys.time(), '%x')`"
output: github_document
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

# global default settings for chunks
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, message = FALSE,
                      fig.dim = c(10, 4), 
                      fig.align = "center",
                      results = "asis"
                      )

# loaded packages; placed here to be able to load global settings
Packages <- c("tidyverse", "dplyr", "readxl", "GGally",
              "arsenal", "patchwork")
invisible(lapply(Packages, library, character.only = TRUE))



# global settings for color palettes
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# theme global setting for ggplot
theme_set(theme_minimal() + 
            theme(legend.position = "bottom") +
            theme(plot.title = element_text(hjust = 0.5, size = 12),
                  plot.subtitle = element_text(hjust = 0.5, size = 8))
          )

```

# Exploration on Filtered, Consolidated Datasets

Now that we've explored the codebook, covariates dataset, and the activity dataset, we can now proceed to merging our covariate dataset and activity dataset.

## Merging Datasets

We first merge our covariate dataset with the total activity count dataset. We should also change the data type to their corresponding variable. Details on the non-numeric variables can be found [here](#re-categorizing-data-types).

Since we've isolated our dataset, we should also remove several variables that have now became irrelevant.

```{r}

total_activity_df <- read_csv("./Datasets/total_activ_data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    seqn = as_factor(seqn)
  )


covar_df <- read_csv("./Datasets/covariates.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    seqn = as_factor(seqn)
  )


merged_df <- inner_join(total_activity_df, covar_df, by = "seqn") %>% 
  mutate_at(
    .vars = vars("ridstatr", "riagendr", "ridreth1", "alq120u", "peascst1", "bpxpuls", "dmdeduc2", "dmdeduc3", "indfminc", 
                 "diq010", "diq220", "diq160", "diq170", "diq190a", "diq190b", "diq190c", "diq200a", "diq200b", "diq200c", 
                 "diq050", "mcq080", "mcq160b", "mcq160c", "mcq160d", "mcq160e", "mcq160f", "mcq160g", "pfq020", "smq040", 
                 "smq050u"),
    .funs = funs(factor)
  ) %>% 
  select(-sddsrvyr)

```

We should also import our codebook just in case we need to look back on which variable is which.

```{r}

codebook_df <- read_csv("./Datasets/variable_list.csv") %>% 
  filter(str_detect(var_name, paste(names(merged_df), collapse = "|")))

```

## Converting and/or Removing "NA" values

Per CDC's codebook, certain variables contain numbers such as "77" or "99" or "99999" to indicate that respondents either refused to provide information or they don't know. As such, we should treat these values as `NA`s since these values does not add any information to our data. We will either remove or convert these values so that our variable distribution is more reflective of the relevant datapoints. 

First, removing those with large amounts of NA values and likely not "relevant" to our interest. 

`ridstatr` is removed as this was an indicator between interview only vs. interview + exam. Based on our summary results, all datapoints received interview + exam.

```{r}

remove_list <- c("ridstatr", "bmxwaist", "diq160", "diq170", "diq190", "diq220", "mcq080", "mcq160", "pfq020", "mcq180", "smq040", "smq050", "alq120", "dmdeduc")

new_merged_df <- select_if(merged_df, 
                       !str_detect(names(merged_df), paste(remove_list, collapse = "|"))
                       )

skimr::skim(new_merged_df)

```


## Evaluating associations

We first evaluate using correlation plot for all the numeric variables to look for 

```{r, fig.dim = c(10, 10)}

matrix_plot <- new_merged_df %>% 
  select_if(is.numeric) %>% 
  ggpairs(
      lower = list(
        continuous = wrap(ggally_points, 
                          color = "#EC0557", alpha = 0.4, size = 0.5)),
      diag = list(
        continuous = wrap(ggally_densityDiag, 
                          color = "steelblue2", fill = "steelblue2",alpha = 0.4)),
      upper = list(
        continuous = wrap(ggally_cor, size = 3)
      )
      ) + 
  theme_bw() +
  theme(axis.text.x = 
          element_text(hjust = 1, vjust = 0.5,
                       angle = 45),
        plot.caption = element_text(hjust = 0, size = 8)
        )

matrix_plot

```

We also utilized GLM to check any kinds of association with all the variables.

```{r, results = "markup"}

saturated_model <- new_merged_df %>% 
  glm(diq010 ~ . -diq010 -seqn, family = binomial, data = ., na.action = na.omit)

summary(saturated_model)

```

# Re-categorizing Data Types

Now that we've minimized our covariates further, we can then begin selecting which ones are `factor` vs. `numeric`. These are the variables which are non-numeric (i.e. `factor`s or any other special formats):

* `seqn`: identifier for survey respondents
* `ridstatr`: interview + exam status.  
  1 = interview only  
  2 = interview + exam  
* `riagendr`: Gender.  
  1 = male  
  2 = female  
* `ridreth1`: Ethnicity/race.  
  1 = Mexican American  
  2 = Other Hispanic  
  3 = Non-Hispanic White  
  4 = Non-Hispanic Black  
  5 = Other (incl. multi-racial)  
* `alq120q`: `numeric`  but some values should be noted as `factor`
  0-365 as range of values  
  777 = refused  
  999 = don't know  
* `alq120u`: units for `alq120q`  
  1 = per week  
  2 = per month  
  3 = per year  
  7 = refused  
  9 = don't know  
* `peascst1`: BP measure status.  
  1 = complete  
  2 = partial  
  3 = not done  
* `bpxpuls`: quality of pulse  
  1 = regular  
  2 = irregular  
* `dmdeduc2`: education level of adults 20+ yrs  
  1	= Less Than 9th Grade  
  2	= 9-11th Grade (Includes 12th grade with no diploma)  
  3	= High School Grad/GED or Equivalent  
  4	= Some College or AA degree  
  5	= College Graduate or above  
  7	= Refused  
  9	= Don't Know  
* `dmdeduc3`: education level of children 6-19 yrs  
  0	= Never Attended / Kindergarten Only  
  1	= 1st Grade  
  2	= 2nd Grade  
  3	= 3rd Grade  
  4	= 4th Grade  
  5	= 5th Grade  
  6	= 6th Grade  
  7	= 7th Grade  
  8	= 8th Grade  
  9	= 9th Grade  
  10 = 10th Grade  
  11 = 11th Grade  
  12 = 12th Grade, No Diploma  
  13 = High School Graduate  
  14 = GED or Equivalent  
  15 = More than high school  
  55 = Less Than 5th Grade  
  66 = Less Than 9th Grade  
  77 = Refused	0	3431	
  99 = Don't know	1	3432  
* `indfminc`: annual family income bracket  
  1	= \$ 0 to \$ 4,999  
  2	= \$ 5,000 to \$ 9,999  
  3	= \$10,000 to \$14,999  
  4	= \$15,000 to \$19,999  
  5	= \$20,000 to \$24,999  
  6	= \$25,000 to \$34,999  
  7	= \$35,000 to \$44,999  
  8	= \$45,000 to \$54,999  
  9	= \$55,000 to \$64,999  
  10	= \$65,000 to \$74,999  
  11	= $75,000 and Over  
  12	= Over $20,000  
  13	= Under $20,000  
  77	= Refused  
  99	= Don't know  
* `diq010`: Told by doctor to have diabetes
* `diq220`: days?
* `diq160`: Told by doctor to have pre-diabetes
* `diq170`: Told by doctor to have health risk of diabetes
* `diq190a`: Told by doctor to control weight
* `diq190b`: Told by doctor to increase physical activity
* `diq190c`: Told by doctor to reduce calorie intake
* `diq200a`: Is the subject controlling weight
* `diq200b`: Is the subject increasing physical activity
* `diq200c`: Is the subject reducing caloric intake
* `diq050`: Is subject taking insulin currently
* `mcq080`: Told by doctor as overweight
* `mcq160*`: Presence of cardiac-related history
  * `b`: CHF
  * `c`: CHD
  * `d`: angina/angina pectoris
  * `e`: MI
  * `f`: Stroke
  * `g`: emphysema
* `pfq020`: impairment/health problem that limits ability to crawl/walk/run/play
* `smq040`: Is subject currently smoking cigarettes
* `smq050u`: Units of measure for `smq050q`, which is an integer for "if not smoking, how long since subject last smoked".

